@model List<Mensaje>
@{
    // Ajustá esto a tu forma de obtener el usuario actual
    var currentUserId = ViewBag.CurrentUserId as string;
    var lastMineId = Model?
        .Where(x => x.EmisorId == currentUserId)
        .OrderByDescending(x => x.FechaEnvio)
        .Select(x => x.Id)
        .FirstOrDefault();


    var otroUsuarioName = Model?
        .Where(m => m.ConversacionId == ViewBag.ConversacionId)
        .SelectMany(m => m.Conversacion?.Participantes ?? Enumerable.Empty<ConversacionUsuario>())
        .Where(p => !p.Eliminada && p.UsuarioId != currentUserId)
        .Select(p => p.Usuario.UserName)
        .FirstOrDefault();
}



<div class="d-flex flex-column border rounded-3 overflow-hidden bg-body shadow-sm"
     style="height: calc(100vh - 140px);">


    <!-- Header -->
    <div class="px-3 py-2 border-bottom bg-body">
        <div class="d-flex align-items-center gap-2">
            <img class="rounded-circle flex-shrink-0"
                 style="width:36px;height:36px; object-fit: cover;"
                 src="https://lh3.googleusercontent.com/aida-public/AB6AXuAKfXT6RT6YYfXo9Bwl8DcQfhZ_cjNET89cwNSuQsovkacbuvXGi0jRYs7Fzy91NU3ScQt-C4O7gG7t2Ihp1HJGwqkbZaDNvtBc1afPnEccu0h_Z_hsb2xYfRsqDgeoPgMdOske_TpkNdbbFDg_4X49TcsUuDJWlAI4dHe8nj-C7eSZkhyQMlrHWXTswQXTHstGrpERyIJP1-LVe57aSK2REozLQZ5tx0DRn1Cj0UjT0uKIokbwgZeeFc5oVWqGZzjg8_d76tsqANwe"
                 alt="avatar" />

            <div class="min-width-0 flex-grow-1">
                <div class="fw-semibold text-truncate">@otroUsuarioName</div>
            </div>

            <button type="button"
                    class="btn btn-sm btn-outline-danger js-delete-chat"
                    data-chat-id="@ViewBag.ConversacionId"
                    title="Eliminar conversación">
                Eliminar
            </button>
        </div>
    </div>

    <!-- Mensajes -->
    <div class="flex-grow-1 overflow-auto p-3" id="chatScroll" style="background: var(--bs-tertiary-bg);">
        <div id="chatMessages">
            @if (Model == null || !Model.Any())
            {
                <div class="text-center text-muted py-5">No hay mensajes todavía.</div>
            }
            else
            {
                foreach (var m in Model)
                {
                    var isMine = currentUserId != null && m.EmisorId == currentUserId;

                    <div class="d-flex mb-2 @(isMine ? "justify-content-end" : "justify-content-start")">
                        <div class="px-3 py-2 shadow-sm @(isMine ? "bg-primary text-white" : "bg-body border")"
                             style="max-width: 75%; border-radius: 18px;">
                            <div class="small">@m.Texto</div>
                            <div class="text-end mt-1" style="font-size: 11px; opacity: .75;">
                                @m.FechaEnvio.ToString("HH:mm")

                                @if (isMine && m.Id == lastMineId)
                                {
                                    <span class="ms-2">
                                        @(m.ReadAt != null ? $"Visto {m.ReadAt.Value:HH:mm}" : "Enviado")
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Input -->
    <div class="p-2 border-top bg-body">
        <form class="d-flex gap-2" id="sendMessageForm" method="post" asp-action="Chat" asp-controller="Mensaje">
            @Html.AntiForgeryToken()
            <input type="hidden" name="ConversacionId" value="@ViewBag.ConversacionId" />

            <input class="form-control"
                   name="texto"
                   placeholder="Escribí un mensaje..."
                   autocomplete="off" />

            <button class="btn btn-primary px-4" type="submit">Enviar</button>
        </form>
    </div>
</div>

